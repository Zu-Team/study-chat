@using Web.Models
@{
    ViewData["Title"] = "Study Chat";
    Layout = "~/Views/StudyChat/_ChatLayout.cshtml";
}

<div class="study-chat-container">
    <!-- Left Sidebar -->
    <aside class="chat-sidebar">
        @{
            var userName = User.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value ?? "User";
            var userEmail = User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? "";
            // Get initials for avatar (first letter of first name and first letter of last name, or first two letters of name)
            var initials = "";
            if (!string.IsNullOrEmpty(userName))
            {
                var nameParts = userName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
                if (nameParts.Length >= 2)
                {
                    initials = (nameParts[0][0].ToString() + nameParts[nameParts.Length - 1][0].ToString()).ToUpper();
                }
                else if (userName.Length >= 2)
                {
                    initials = userName.Substring(0, 2).ToUpper();
                }
                else
                {
                    initials = userName.Substring(0, 1).ToUpper() + userName.Substring(0, 1).ToUpper();
                }
            }
            else if (!string.IsNullOrEmpty(userEmail))
            {
                initials = userEmail.Substring(0, 2).ToUpper();
            }
            else
            {
                initials = "U";
            }
        }
        <div class="sidebar-header" style="display: flex; align-items: center; gap: 12px; padding: 1rem; border-bottom: 1px solid #333;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">
                @initials
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="color: #ffffff; font-weight: 500; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    @userName
                </div>
                <div style="color: #888888; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    @userEmail
                </div>
            </div>
            <div style="position: relative;">
                <button type="button" onclick="toggleUserMenu()" style="background: transparent; border: none; color: #888888; cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                    </svg>
                </button>
                <div id="userMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 8px 0; min-width: 150px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 1000;">
                    <a asp-action="Logout" asp-controller="Account" style="display: block; padding: 10px 16px; color: #ffffff; text-decoration: none; font-size: 0.9rem; transition: background 0.2s;" 
                       onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background='transparent'">
                        Logout
                    </a>
                </div>
            </div>
        </div>
        
        <div class="sidebar-content">
            @if (ViewBag.ErrorMessage != null)
            {
                <div class="alert alert-danger" role="alert" style="margin: 0 0 1rem 0;">
                    @ViewBag.ErrorMessage
                </div>
            }
            <button class="btn-new-chat" type="button" id="btnNewChat" onclick="showNewChatModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                New Chat
            </button>
            
            <hr class="sidebar-divider" />
            
            <div class="chat-list">
                @if (ViewBag.Chats != null)
                {
                    var chatList = (List<Web.Models.Chat>)ViewBag.Chats;
                    var selectedChatId = ViewBag.SelectedChat != null ? ((Web.Models.Chat)ViewBag.SelectedChat).Id : (long?)null;
                    
                    @if (chatList.Count == 0)
                    {
                        <div class="text-center text-muted" style="padding: 2rem 1rem; color: #888888;">
                            <p>No chats yet. Start a new conversation!</p>
                        </div>
                    }
                    else
                    {
                    @foreach (var chat in chatList)
                    {
                        var isActive = selectedChatId.HasValue && chat.Id == selectedChatId.Value;
                        <a href="@Url.Action("Index", "StudyChat", new { chatId = chat.Id })" 
                               class="chat-item @(isActive ? "active" : "")">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chat-icon">
                                <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
                            </svg>
                            <span class="chat-name">@(chat.Name ?? "Untitled Chat")</span>
                        </a>
                    }
                    }
                }
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="chat-main">
        @{
            var chats = ViewBag.Chats as List<Web.Models.Chat> ?? new List<Web.Models.Chat>();
            var hasChats = chats.Count > 0;
            var hasSelectedChat = ViewBag.HasSelectedChat == true;
        }
        
        @if (!hasChats)
        {
            <!-- No Chats State -->
            <div class="no-chats-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 2rem; text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ“š</div>
                <h2 style="color: #ffffff; margin-bottom: 0.5rem; font-size: 1.5rem;">Create a chat to start studying</h2>
                <p style="color: #888888; margin-bottom: 2rem;">Click "New Chat" to begin your learning journey</p>
            </div>
        }
        else
        {
            <!-- Chat Header -->
            <header class="chat-header">
                <h3 class="chat-title">@(ViewBag.ChatTitle ?? "Study Chat")</h3>
            </header>

            <!-- Messages Area -->
            <div class="messages-container" id="messagesContainer">
                @if (hasSelectedChat && ViewBag.Messages != null)
                {
                    var messages = (List<Web.Models.Message>)ViewBag.Messages;
                    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                    
                    @if (messages.Count == 0)
                    {
                        <div class="empty-state">
                            <div class="empty-state-text">No messages yet. Start the conversation!</div>
                        </div>
                    }
                    else
                    {
                        @foreach (var message in messages)
                        {
                            // Check if message is from the current user
                            // userId is a string from claims, message.SenderId is a long?
                            // Convert both to strings for comparison, or compare as numbers
                            var isUserMessage = false;
                            if (message.SenderId.HasValue && !string.IsNullOrEmpty(userId))
                            {
                                // Try to parse userId as long and compare, or compare as strings
                                if (long.TryParse(userId, out var userIdLong))
                                {
                                    isUserMessage = message.SenderId.Value == userIdLong;
                                }
                                else
                                {
                                    // Fallback to string comparison
                                    isUserMessage = message.SenderId.Value.ToString() == userId;
                                }
                            }
                            // If SenderId is null, it's an AI message (assistant)
                            // If SenderId is 1 (AI user), it's also an AI message
                            // Only messages with SenderId matching current user are user messages
                            <div class="message @(isUserMessage ? "user-message" : "assistant-message")">
                                <div class="message-bubble">
                                    @Html.Raw(message.Content.Replace("\n", "<br/>"))
                                </div>
                            </div>
                        }
                    }
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ’¬</div>
                        <div class="empty-state-text">Select a chat from the sidebar to start your study session</div>
                    </div>
                }
            </div>

            <!-- Message Input Area (only show if chat is selected) -->
            @if (hasSelectedChat)
            {
                <div class="message-input-container">
                    <form class="message-form" id="messageForm">
                        @Html.AntiForgeryToken()
                        @{
                            var selectedChat = ViewBag.SelectedChat as Web.Models.Chat;
                            var currentChatId = selectedChat?.Id;
                        }
                        <input type="hidden" id="currentChatId" value="@currentChatId" />
                        <div class="input-wrapper">
                            <textarea 
                                class="message-input" 
                                id="messageInput" 
                                placeholder="Type your message here..." 
                                rows="1"
                                required></textarea>
                            <button type="submit" class="send-button" aria-label="Send message">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm-1.138-1.138L13.424 1.87 4.338 6.636l1.16 1.296Z"/>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            }
        }
    </main>
    
    <!-- New Chat Modal -->
    <div id="newChatModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 2rem; min-width: 400px; max-width: 90%; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);">
            <h2 style="color: #ffffff; margin-bottom: 1.5rem; font-size: 1.5rem;">Create New Chat</h2>
            <form asp-action="NewChat" asp-controller="StudyChat" method="post" id="newChatForm">
                <div style="margin-bottom: 1.5rem;">
                    <label for="chatName" style="display: block; color: #cccccc; margin-bottom: 0.5rem; font-size: 0.9rem;">Chat Name</label>
                    <input 
                        type="text" 
                        id="chatName" 
                        name="chatName" 
                        placeholder="Enter chat name (e.g., Math Study, History Review)"
                        style="width: 100%; padding: 0.75rem; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #ffffff; font-size: 1rem;"
                        maxlength="500"
                        autofocus
                        required />
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button 
                        type="button" 
                        onclick="closeNewChatModal()"
                        style="padding: 0.75rem 1.5rem; background: #333; color: #ffffff; border: 1px solid #555; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        style="padding: 0.75rem 1.5rem; background: #0066cc; color: #ffffff; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                        Create Chat
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // User Menu Toggle
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('userMenu');
            const button = event.target.closest('button[onclick="toggleUserMenu()"]');
            if (menu && !menu.contains(event.target) && !button) {
                menu.style.display = 'none';
            }
        });

        // New Chat Modal Functions
        function showNewChatModal() {
            const modal = document.getElementById('newChatModal');
            const input = document.getElementById('chatName');
            if (modal) {
                modal.style.display = 'flex';
                if (input) {
                    setTimeout(() => input.focus(), 100);
                }
            }
        }

        function closeNewChatModal() {
            const modal = document.getElementById('newChatModal');
            const form = document.getElementById('newChatForm');
            if (modal) {
                modal.style.display = 'none';
            }
            if (form) {
                form.reset();
            }
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('newChatModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeNewChatModal();
                    }
                });
            }

            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeNewChatModal();
                }
            });
        });

        // Auto-resize textarea
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messagesContainer');

        if (messageInput) {
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Handle Enter key: Send message on Enter, new line on Shift+Enter
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent default new line
                    // Trigger form submission
                    const form = document.getElementById('messageForm');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
                // Shift+Enter will create a new line (default behavior)
            });

            // Scroll to bottom on load
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Handle form submission - send message to AI webhook
        const messageForm = document.getElementById('messageForm');
        if (messageForm) {
            messageForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const input = messageInput.value.trim();
                
                if (!input) {
                    return;
                }

                // Disable form while sending
                const sendButton = messageForm.querySelector('.send-button');
                const originalButtonContent = sendButton?.innerHTML;
                if (sendButton) {
                    sendButton.disabled = true;
                    sendButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM7 4a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 7 4zm0 6a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1z"/></svg>';
                }
                messageInput.disabled = true;

                // Get current chat ID
                const chatIdInput = document.getElementById('currentChatId');
                const currentChatId = chatIdInput ? (chatIdInput.value ? parseInt(chatIdInput.value) : null) : null;

                // Add user message to chat immediately (will be replaced when page reloads)
                addMessageToChat(input, true);

                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';

                try {
                    // Send message to server with chatId
                    const response = await fetch('/StudyChat/SendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin', // Include cookies for authentication
                        body: JSON.stringify({ 
                            message: input,
                            chatId: currentChatId
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Debug logging
                    console.log('Response data:', data);
                    
                    // Add AI response to chat (will be replaced when page reloads)
                    if (data.success && data.aiMessage) {
                        addMessageToChat(data.aiMessage, false);
                        
                        // Log debug info if available
                        if (data.debug) {
                            console.log('Debug info:', data.debug);
                        }
                        
                        // Reload page to show all messages from database
                        // This ensures we see the saved user message and any AI message saved by the webhook
                        if (data.chatId) {
                            // Update the chatId in the hidden input if it was created
                            if (chatIdInput && !currentChatId) {
                                chatIdInput.value = data.chatId;
                            }
                            // Reload after a short delay to allow the AI message to be saved
                            setTimeout(() => {
                                window.location.href = '/StudyChat?chatId=' + data.chatId;
                            }, 500);
                        } else if (currentChatId) {
                            // Reload current chat
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        }
                    } else {
                        // Log error details
                        console.error('Invalid response:', data);
                        throw new Error(data.error || 'Invalid response from server');
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    console.error('Error details:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Try to get more detailed error message
                    let errorMessage = 'Sorry, I encountered an error. Please try again.';
                    try {
                        if (error.message) {
                            errorMessage = `Error: ${error.message}`;
                        }
                        // If error has response data, try to extract error message
                        if (error.response) {
                            const errorData = await error.response.json().catch(() => null);
                            if (errorData?.error) {
                                errorMessage = `Error: ${errorData.error}`;
                                if (errorData.details) {
                                    errorMessage += ` (${errorData.details})`;
                                }
                                if (errorData.traceId) {
                                    console.error('Trace ID:', errorData.traceId);
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing error message:', e);
                    }
                    
                    // Show error message
                    addMessageToChat(errorMessage, false);
                } finally {
                    // Re-enable form
                    if (sendButton) {
                        sendButton.disabled = false;
                        if (originalButtonContent) {
                            sendButton.innerHTML = originalButtonContent;
                        }
                    }
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            });
        }

        // Function to add message to chat UI
        function addMessageToChat(message, isUser) {
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) return;

            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            // Convert newlines to <br> and escape HTML
            const escapedMessage = message
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br/>');
            
            bubbleDiv.innerHTML = escapedMessage;
            messageDiv.appendChild(bubbleDiv);
            
            // Add to container
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    </script>
}

