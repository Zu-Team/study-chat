@using Web.Models
@{
    ViewData["Title"] = "Study Chat";
    Layout = "~/Views/StudyChat/_ChatLayout.cshtml";
}

<div class="study-chat-container">
    <!-- Left Sidebar -->
    <aside class="chat-sidebar">
        <div class="sidebar-header">
            <h2 class="app-title">StudyChat</h2>
            <div style="margin-top: 0.5rem;">
                <a asp-action="Logout" asp-controller="Account" class="text-decoration-none" style="color: #888888; font-size: 0.85rem;">Logout</a>
            </div>
        </div>
        
        <div class="sidebar-content">
            @if (ViewBag.ErrorMessage != null)
            {
                <div class="alert alert-danger" role="alert" style="margin: 0 0 1rem 0;">
                    @ViewBag.ErrorMessage
                </div>
            }
            <form asp-action="NewChat" asp-controller="StudyChat" method="post" style="margin: 0;">
                <button class="btn-new-chat" type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    New Chat
                </button>
            </form>
            
            <hr class="sidebar-divider" />
            
            <div class="chat-list">
                @if (ViewBag.Chats != null)
                {
                    var chats = (List<Web.Models.Chat>)ViewBag.Chats;
                    var selectedChatId = ViewBag.SelectedChat != null ? ((Web.Models.Chat)ViewBag.SelectedChat).Id : (Guid?)null;
                    
                    @if (chats.Count == 0)
                    {
                        <div class="text-center text-muted" style="padding: 2rem 1rem; color: #888888;">
                            <p>No chats yet. Start a new conversation!</p>
                        </div>
                    }
                    else
                    {
                    @foreach (var chat in chats)
                    {
                        var isActive = selectedChatId.HasValue && chat.Id == selectedChatId.Value;
                        <a href="@Url.Action("Index", "StudyChat", new { chatId = chat.Id })" 
                               class="chat-item @(isActive ? "active" : "")">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chat-icon">
                                <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
                            </svg>
                            <span class="chat-name">@(chat.Name ?? "Untitled Chat")</span>
                        </a>
                    }
                    }
                }
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="chat-main">
        <!-- Chat Header -->
        <header class="chat-header">
            <h3 class="chat-title">@(ViewBag.ChatTitle ?? "Study Chat")</h3>
        </header>

        <!-- Messages Area -->
        <div class="messages-container" id="messagesContainer">
            @if (ViewBag.HasSelectedChat == true && ViewBag.Messages != null)
            {
                var messages = (List<Web.Models.Message>)ViewBag.Messages;
                var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                
                @if (messages.Count == 0)
                {
                    <div class="empty-state">
                        <div class="empty-state-text">No messages yet. Start the conversation!</div>
                    </div>
                }
                else
                {
                    @foreach (var message in messages)
                    {
                        var isUserMessage = message.SenderId.HasValue && message.SenderId.ToString() == userId;
                        <div class="message @(isUserMessage ? "user-message" : "assistant-message")">
                            <div class="message-bubble">
                                @Html.Raw(message.Content.Replace("\n", "<br/>"))
                            </div>
                        </div>
                    }
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ’¬</div>
                    <div class="empty-state-text">Start a new chat to begin your study session</div>
                </div>
            }
        </div>

        <!-- Message Input Area -->
        <div class="message-input-container">
            <form class="message-form" id="messageForm">
                <div class="input-wrapper">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Type your message here..." 
                        rows="1"
                        required></textarea>
                    <button type="submit" class="send-button" aria-label="Send message">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm-1.138-1.138L13.424 1.87 4.338 6.636l1.16 1.296Z"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

@section Scripts {
    <script>
        // Auto-resize textarea
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messagesContainer');

        if (messageInput) {
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Scroll to bottom on load
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Handle form submission (placeholder - no actual logic yet)
        const messageForm = document.getElementById('messageForm');
        if (messageForm) {
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                // TODO: Add actual message sending logic
                const input = messageInput.value.trim();
                if (input) {
                    console.log('Message:', input);
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                }
            });
        }
    </script>
}

