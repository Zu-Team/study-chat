@using Web.Models
@{
    ViewData["Title"] = "Study Chat";
    Layout = "~/Views/StudyChat/_ChatLayout.cshtml";
}

<div class="study-chat-container">
    <!-- Left Sidebar -->
    <aside class="chat-sidebar">
        @{
            var userName = User.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value ?? "User";
            var userEmail = User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? "";
            // Get initials for avatar (first letter of first name and first letter of last name, or first two letters of name)
            var initials = "";
            if (!string.IsNullOrEmpty(userName))
            {
                var nameParts = userName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
                if (nameParts.Length >= 2)
                {
                    initials = (nameParts[0][0].ToString() + nameParts[nameParts.Length - 1][0].ToString()).ToUpper();
                }
                else if (userName.Length >= 2)
                {
                    initials = userName.Substring(0, 2).ToUpper();
                }
                else
                {
                    initials = userName.Substring(0, 1).ToUpper() + userName.Substring(0, 1).ToUpper();
                }
            }
            else if (!string.IsNullOrEmpty(userEmail))
            {
                initials = userEmail.Substring(0, 2).ToUpper();
            }
            else
            {
                initials = "U";
            }
        }
        <div class="sidebar-header" style="display: flex; align-items: center; gap: 12px; padding: 1rem; border-bottom: 1px solid #333;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">
                @initials
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="color: #ffffff; font-weight: 500; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    @userName
                </div>
                <div style="color: #888888; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    @userEmail
                </div>
            </div>
            <div style="position: relative;">
                <button type="button" onclick="toggleUserMenu()" style="background: transparent; border: none; color: #888888; cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                    </svg>
                </button>
                <div id="userMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 8px 0; min-width: 150px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 1000;">
                    <a asp-action="Logout" asp-controller="Account" style="display: block; padding: 10px 16px; color: #ffffff; text-decoration: none; font-size: 0.9rem; transition: background 0.2s;" 
                       onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background='transparent'">
                        Logout
                    </a>
                </div>
            </div>
        </div>
        
        <div class="sidebar-content">
            @if (ViewBag.ErrorMessage != null)
            {
                <div class="alert alert-danger" role="alert" style="margin: 0 0 1rem 0;">
                    @ViewBag.ErrorMessage
                </div>
            }
            <button class="btn-new-chat" type="button" id="btnNewChat" onclick="showNewChatModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                New Chat
            </button>
            
            <hr class="sidebar-divider" />
            
            <div class="chat-list">
                @if (ViewBag.Chats != null)
                {
                    var chatList = (List<Web.Models.Chat>)ViewBag.Chats;
                    var selectedChatId = ViewBag.SelectedChat != null ? ((Web.Models.Chat)ViewBag.SelectedChat).Id : (long?)null;
                    
                    @if (chatList.Count == 0)
                    {
                        <div class="text-center text-muted" style="padding: 2rem 1rem; color: #888888;">
                            <p>No chats yet. Start a new conversation!</p>
                        </div>
                    }
                    else
                    {
                    @foreach (var chat in chatList)
                    {
                        var isActive = selectedChatId.HasValue && chat.Id == selectedChatId.Value;
                        <a href="@Url.Action("Index", "StudyChat", new { chatId = chat.Id })" 
                               class="chat-item @(isActive ? "active" : "")">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chat-icon">
                                <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
                            </svg>
                            <span class="chat-name">@(chat.Name ?? "Untitled Chat")</span>
                        </a>
                    }
                    }
                }
            </div>
            
            <!-- Customize AI Button at bottom of sidebar -->
            <div style="padding: 1rem; border-top: 1px solid #2a2a2a; margin-top: auto;">
                <button class="btn-customize-ai" type="button" id="btnCustomizeAI" onclick="showCustomizeAIModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px;">
                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 9.207 2.828 1.536 1.536 2.828 9.207 10.5l-1.586 1.586a.5.5 0 0 1-.353.146H4.5a.5.5 0 0 1-.5-.5v-3.268a.5.5 0 0 1 .146-.353z"/>
                    </svg>
                    Customize AI
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="chat-main">
        <!-- Mobile Menu Toggle Button -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
            </svg>
        </button>
        
        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        @{
            var chats = ViewBag.Chats as List<Web.Models.Chat> ?? new List<Web.Models.Chat>();
            var hasChats = chats.Count > 0;
            var hasSelectedChat = ViewBag.HasSelectedChat == true;
        }
        
        @if (!hasChats)
        {
            <!-- No Chats State -->
            <div class="no-chats-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 2rem; text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üìö</div>
                <h2 style="color: #ffffff; margin-bottom: 0.5rem; font-size: 1.5rem;">Create a chat to start studying</h2>
                <p style="color: #888888; margin-bottom: 2rem;">Click "New Chat" in the sidebar to begin your learning journey</p>
            </div>
        }
        else
        {
            <!-- Chat Header -->
            <header class="chat-header">
                <h3 class="chat-title">@(ViewBag.ChatTitle ?? "Study Chat")</h3>
            </header>

            <!-- Messages Area -->
            <div class="messages-container" id="messagesContainer">
                @if (hasSelectedChat && ViewBag.Messages != null)
                {
                    var messages = (List<Web.Models.Message>)ViewBag.Messages;
                    var selectedChat = ViewBag.SelectedChat as Web.Models.Chat;
                    var currentChatId = selectedChat?.Id;
                    // Get userId from ViewBag (set by controller) or from claims as fallback
                    var userId = ViewBag.UserId != null ? ViewBag.UserId.ToString() : User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                    // Also try studychat_user_id claim
                    if (string.IsNullOrEmpty(userId))
                    {
                        userId = User.FindFirst("studychat_user_id")?.Value;
                    }
                    
                    @if (messages.Count == 0)
                    {
                        <div class="empty-state">
                            <div class="empty-state-text">No messages yet. Start the conversation!</div>
                        </div>
                    }
                    else
                    {
                        @foreach (var message in messages)
                        {
                            // Check if message is from the current user
                            // Rules:
                            // - sender_id = 1 ‚Üí Always AI message (left side, assistant-message)
                            // - sender_id = current user id ‚Üí User message (right side, user-message)
                            // - sender_id = null ‚Üí AI message (left side, assistant-message)
                            // - sender_id = any other id ‚Üí AI message (left side, assistant-message)
                            var isUserMessage = false;
                            
                            if (message.SenderId.HasValue)
                            {
                                // If sender_id is 1, it's always an AI message (AI Assistant user)
                                if (message.SenderId.Value == 1)
                                {
                                    isUserMessage = false; // AI message
                                }
                                else if (!string.IsNullOrEmpty(userId))
                                {
                                    // Check if sender_id matches current user id
                                    long userIdLong;
                                    if (long.TryParse(userId, out userIdLong))
                                    {
                                        // Only messages with sender_id matching current user are user messages
                                        isUserMessage = message.SenderId.Value == userIdLong;
                                    }
                                    else
                                    {
                                        // Fallback to string comparison
                                        isUserMessage = message.SenderId.Value.ToString() == userId;
                                    }
                                }
                                // If userId is null/empty, treat as AI message
                            }
                            // If SenderId is null, it's an AI message (assistant)
                            <div class="message @(isUserMessage ? "user-message" : "assistant-message")" data-message-id="@message.Id">
                                <div class="message-bubble">
                                    @Html.Raw(message.Content.Replace("\n", "<br/>"))
                                </div>
                            </div>
                        }
                        
                        <!-- Quiz Container (will be populated by JavaScript) -->
                        @if (currentChatId.HasValue)
                        {
                            <div id="quizContainer" data-chat-id="@currentChatId.Value" style="display: none;"></div>
                        }
                    }
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <div class="empty-state-text">Select a chat from the sidebar to start your study session</div>
                    </div>
                }
            </div>

            <!-- Message Input Area (only show if chat is selected) -->
            @if (hasSelectedChat)
            {
                <div class="message-input-container">
                    <form class="message-form" id="messageForm">
                        @Html.AntiForgeryToken()
                        @{
                            var selectedChat = ViewBag.SelectedChat as Web.Models.Chat;
                            var currentChatId = selectedChat?.Id;
                        }
                        @{
                            var selectedChatForInput = ViewBag.SelectedChat as Web.Models.Chat;
                            var currentChatIdForInput = selectedChatForInput?.Id;
                            var userIdForInput = ViewBag.UserId != null ? ViewBag.UserId.ToString() : User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                            if (string.IsNullOrEmpty(userIdForInput))
                            {
                                userIdForInput = User.FindFirst("studychat_user_id")?.Value;
                            }
                        }
                        <input type="hidden" id="currentChatId" value="@currentChatIdForInput" data-user-id="@userIdForInput" />
                        <div class="input-wrapper">
                            <textarea 
                                class="message-input" 
                                id="messageInput" 
                                placeholder="Type your message here..." 
                                rows="1"
                                required></textarea>
                            <button type="button" class="quiz-button" id="quizButton" aria-label="Toggle quiz mode" title="Quiz Mode">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                    <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286m1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94"/>
                                </svg>
                            </button>
                            <button type="submit" class="send-button" aria-label="Send message">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm-1.138-1.138L13.424 1.87 4.338 6.636l1.16 1.296Z"/>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            }
        }
    </main>
    
    <!-- Toast Notification -->
    <div id="toastNotification" class="toast-notification">
        <div class="toast-content">
            <div class="toast-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 2.384 5.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                </svg>
            </div>
            <div class="toast-message" id="toastMessage"></div>
        </div>
    </div>
    
    <!-- Customize AI Modal -->
    <div id="customizeAIModal" class="customize-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 2rem; min-width: 500px; max-width: 90%; max-height: 90vh; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column;">
            <h2 style="color: #ffffff; margin-bottom: 1.5rem; font-size: 1.5rem;">Customize AI</h2>
            <div style="margin-bottom: 1.5rem; flex: 1; display: flex; flex-direction: column; min-height: 200px;">
                <label for="customizeAIText" style="display: block; color: #cccccc; margin-bottom: 0.5rem; font-size: 0.9rem;">AI Instructions (max 500 characters)</label>
                <textarea 
                    id="customizeAIText" 
                    maxlength="500"
                    rows="8"
                    style="width: 100%; padding: 0.75rem; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 8px; color: #e0e0e0; font-size: 0.95rem; font-family: inherit; resize: vertical; min-height: 150px; flex: 1;"
                    placeholder="Enter your custom AI instructions here..."></textarea>
                <div style="color: #888888; font-size: 0.85rem; margin-top: 0.5rem; text-align: right;">
                    <span id="customizeAICharCount">0</span>/500
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="closeCustomizeAIModal()" style="padding: 0.75rem 1.5rem; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 8px; color: #e0e0e0; cursor: pointer; font-size: 0.95rem; transition: all 0.2s;">
                    Cancel
                </button>
                <button type="button" id="btnSaveCustomizeAI" onclick="saveCustomizeAI()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #4a9eff 0%, #3a8eef 100%); border: none; border-radius: 8px; color: #ffffff; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s;">
                    Save
                </button>
            </div>
        </div>
    </div>
    
    <!-- New Chat Modal -->
    <div id="newChatModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1a1a1a; border-radius: 12px; padding: 2rem; min-width: 400px; max-width: 90%; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);">
            <h2 style="color: #ffffff; margin-bottom: 1.5rem; font-size: 1.5rem;">Create New Chat</h2>
            <form asp-action="NewChat" asp-controller="StudyChat" method="post" id="newChatForm">
                <div style="margin-bottom: 1.5rem;">
                    <label for="chatName" style="display: block; color: #cccccc; margin-bottom: 0.5rem; font-size: 0.9rem;">Chat Name</label>
                    <input 
                        type="text" 
                        id="chatName" 
                        name="chatName" 
                        placeholder="Enter chat name (e.g., Math Study, History Review)"
                        style="width: 100%; padding: 0.75rem; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #ffffff; font-size: 1rem;"
                        maxlength="500"
                        autofocus
                        required />
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button 
                        type="button" 
                        onclick="closeNewChatModal()"
                        style="padding: 0.75rem 1.5rem; background: #333; color: #ffffff; border: 1px solid #555; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        style="padding: 0.75rem 1.5rem; background: #0066cc; color: #ffffff; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                        Create Chat
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // User Menu Toggle
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('userMenu');
            const button = event.target.closest('button[onclick="toggleUserMenu()"]');
            if (menu && !menu.contains(event.target) && !button) {
                menu.style.display = 'none';
            }
        });

        // New Chat Modal Functions
        function showNewChatModal() {
            const modal = document.getElementById('newChatModal');
            const input = document.getElementById('chatName');
            if (modal) {
                modal.style.display = 'flex';
                if (input) {
                    setTimeout(() => input.focus(), 100);
                }
            }
        }

        function closeNewChatModal() {
            const modal = document.getElementById('newChatModal');
            const form = document.getElementById('newChatForm');
            if (modal) {
                modal.style.display = 'none';
            }
            if (form) {
                form.reset();
            }
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('newChatModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeNewChatModal();
                    }
                });
            }

            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeNewChatModal();
                    closeCustomizeAIModal();
                }
            });
        });

        // Customize AI Modal Functions
        function showCustomizeAIModal() {
            const modal = document.getElementById('customizeAIModal');
            const textarea = document.getElementById('customizeAIText');
            if (modal) {
                modal.style.display = 'flex';
                // Load existing customization
                loadCustomizeAI();
                if (textarea) {
                    setTimeout(() => textarea.focus(), 100);
                }
            }
        }

        function closeCustomizeAIModal() {
            const modal = document.getElementById('customizeAIModal');
            const textarea = document.getElementById('customizeAIText');
            if (modal) {
                // Add fade-out animation
                modal.classList.add('modal-closing');
                // Hide after animation completes
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.remove('modal-closing');
                }, 300); // Match CSS animation duration
            }
            if (textarea) {
                textarea.value = '';
                updateCharCount();
            }
        }

        // Load customization from server
        async function loadCustomizeAI() {
            try {
                const response = await fetch('/StudyChat/GetCustomizeAI', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const textarea = document.getElementById('customizeAIText');
                    if (textarea && data.text) {
                        textarea.value = data.text;
                        updateCharCount();
                    }
                }
            } catch (error) {
                console.error('Failed to load customization:', error);
            }
        }

        // Save customization to server
        async function saveCustomizeAI() {
            const textarea = document.getElementById('customizeAIText');
            const saveButton = document.getElementById('btnSaveCustomizeAI');
            
            if (!textarea) return;
            
            const text = textarea.value.trim();
            
            // Disable save button
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';
            }
            
            try {
                const response = await fetch('/StudyChat/SaveCustomizeAI', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ text: text })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Show success animation first
                        showToast('AI customization saved successfully!', 'success');
                        // Close modal with animation after a short delay (so toast is visible)
                        setTimeout(() => {
                            closeCustomizeAIModal();
                        }, 200);
                    } else {
                        showToast('Failed to save: ' + (data.error || 'Unknown error'), 'error');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    showToast('Failed to save: ' + (errorData.error || 'Server error'), 'error');
                }
            } catch (error) {
                console.error('Failed to save customization:', error);
                showToast('Failed to save customization. Please try again.', 'error');
            } finally {
                // Re-enable save button
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save';
                }
            }
        }

        // Update character count
        function updateCharCount() {
            const textarea = document.getElementById('customizeAIText');
            const charCount = document.getElementById('customizeAICharCount');
            if (textarea && charCount) {
                const count = textarea.value.length;
                charCount.textContent = count;
                if (count > 450) {
                    charCount.style.color = '#ff6b6b';
                } else if (count > 400) {
                    charCount.style.color = '#f59e0b';
                } else {
                    charCount.style.color = '#888888';
                }
            }
        }

        // Toast Notification Functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toast || !toastMessage) return;
            
            // Set message
            toastMessage.textContent = message;
            
            // Set icon based on type
            const toastIcon = toast.querySelector('.toast-icon');
            if (toastIcon) {
                if (type === 'success') {
                    toastIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 2.384 5.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>';
                } else {
                    toastIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>';
                }
            }
            
            // Remove existing classes and add new ones
            toast.className = `toast-notification toast-${type}`;
            
            // Trigger animation by adding show class
            setTimeout(() => {
                toast.classList.add('toast-show');
            }, 10);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                hideToast();
            }, 3000);
        }
        
        function hideToast() {
            const toast = document.getElementById('toastNotification');
            if (toast) {
                toast.classList.remove('toast-show');
            }
        }

        // Add character count listener and modal close on outside click
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('customizeAIText');
            if (textarea) {
                textarea.addEventListener('input', updateCharCount);
            }
            
            // Close customize modal when clicking outside
            const customizeModal = document.getElementById('customizeAIModal');
            if (customizeModal) {
                customizeModal.addEventListener('click', function(e) {
                    if (e.target === customizeModal) {
                        closeCustomizeAIModal();
                    }
                });
            }
        });

        // Auto-resize textarea
        const messageInput = document.getElementById('messageInput');
        const messagesContainer = document.getElementById('messagesContainer');

        if (messageInput) {
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Handle Enter key: Send message on Enter, new line on Shift+Enter
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent default new line
                    // Trigger form submission
                    const form = document.getElementById('messageForm');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
                // Shift+Enter will create a new line (default behavior)
            });

            // Scroll to bottom on load
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.querySelector('.chat-sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        
        function toggleSidebar() {
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
            if (sidebarOverlay) {
                sidebarOverlay.classList.toggle('active');
            }
        }
        
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', toggleSidebar);
        }
        
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }
        
        // Close sidebar when clicking on a chat item (mobile)
        const chatItems = document.querySelectorAll('.chat-item');
        chatItems.forEach(item => {
            item.addEventListener('click', function() {
                // Only close on mobile
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        toggleSidebar();
                    }, 300); // Small delay for navigation
                }
            });
        });
        
        // Quiz mode state
        let quizModeActive = false;
        const quizButton = document.getElementById('quizButton');
        
        // Toggle quiz mode
        if (quizButton) {
            quizButton.addEventListener('click', function() {
                quizModeActive = !quizModeActive;
                if (quizModeActive) {
                    quizButton.classList.add('active');
                    quizButton.setAttribute('title', 'Quiz Mode: ON');
                } else {
                    quizButton.classList.remove('active');
                    quizButton.setAttribute('title', 'Quiz Mode: OFF');
                }
            });
        }

        // Handle form submission - send message to AI webhook
        const messageForm = document.getElementById('messageForm');
        if (messageForm) {
            messageForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const input = messageInput.value.trim();
                
                if (!input) {
                    return;
                }

                // Determine message type based on quiz mode
                const messageType = quizModeActive ? 'quiz' : 'normal';

                // Disable form while sending
                const sendButton = messageForm.querySelector('.send-button');
                const originalButtonContent = sendButton?.innerHTML;
                if (sendButton) {
                    sendButton.disabled = true;
                    sendButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM7 4a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 7 4zm0 6a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1z"/></svg>';
                }
                messageInput.disabled = true;

                // Get current chat ID
                const chatIdInput = document.getElementById('currentChatId');
                const currentChatId = chatIdInput ? (chatIdInput.value ? parseInt(chatIdInput.value) : null) : null;

                // Add user message to chat immediately (will be replaced when polling gets the real message)
                addMessageToChat(input, true);
                // Track this message content to avoid duplicates when polling
                const messageKey = input.trim().substring(0, 50);
                recentlyAddedMessages.set(messageKey, Date.now());

                // Clear input
                    messageInput.value = '';
                    messageInput.style.height = 'auto';

                try {
                    // Send message to server with chatId and message type
                    const response = await fetch('/StudyChat/SendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin', // Include cookies for authentication
                        body: JSON.stringify({ 
                            message: input,
                            chatId: currentChatId,
                            type: messageType
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Debug logging
                    console.log('Response data:', data);
                    
                    // Add AI response to chat immediately (will be replaced when polling gets the real message)
                    if (data.success && data.aiMessage) {
                        addMessageToChat(data.aiMessage, false);
                        // Track this message content to avoid duplicates when polling
                        const aiMessageKey = data.aiMessage.trim().substring(0, 50);
                        recentlyAddedMessages.set(aiMessageKey, Date.now());
                        
                        // Log debug info if available
                        if (data.debug) {
                            console.log('Debug info:', data.debug);
                        }
                        
                        // Update chatId if it was created
                        const finalChatId = data.chatId || currentChatId;
                        if (chatIdInput && !currentChatId && data.chatId) {
                            chatIdInput.value = data.chatId;
                        }
                        
                        // Poll for new messages from the server instead of reloading
                        // The webhook may save additional messages, so we check for updates
                        if (finalChatId) {
                            // Start polling for new messages after a short delay
                            setTimeout(() => {
                                pollForNewMessages(finalChatId, 3); // Poll up to 3 times
                            }, 1000);
                        }
                    } else {
                        // Log error details
                        console.error('Invalid response:', data);
                        throw new Error(data.error || 'Invalid response from server');
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    console.error('Error details:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Try to get more detailed error message
                    let errorMessage = 'Sorry, I encountered an error. Please try again.';
                    try {
                        if (error.message) {
                            errorMessage = `Error: ${error.message}`;
                        }
                        // If error has response data, try to extract error message
                        if (error.response) {
                            const errorData = await error.response.json().catch(() => null);
                            if (errorData?.error) {
                                errorMessage = `Error: ${errorData.error}`;
                                if (errorData.details) {
                                    errorMessage += ` (${errorData.details})`;
                                }
                                if (errorData.traceId) {
                                    console.error('Trace ID:', errorData.traceId);
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing error message:', e);
                    }
                    
                    // Show error message
                    addMessageToChat(errorMessage, false);
                } finally {
                    // Re-enable form
                    if (sendButton) {
                        sendButton.disabled = false;
                        if (originalButtonContent) {
                            sendButton.innerHTML = originalButtonContent;
                        }
                    }
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            });
        }

        // Function to add message to chat UI
        function addMessageToChat(message, isUser, messageId = null) {
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) return;

            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
            if (messageId) {
                messageDiv.setAttribute('data-message-id', messageId);
            }
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            // Convert newlines to <br> and escape HTML
            const escapedMessage = message
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br/>');
            
            bubbleDiv.innerHTML = escapedMessage;
            messageDiv.appendChild(bubbleDiv);
            
            // Add to container
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Track message IDs to avoid duplicates
        const displayedMessageIds = new Set();
        // Track recently added messages by content (to avoid duplicates before server assigns ID)
        const recentlyAddedMessages = new Map(); // content -> timestamp
        
        // Initialize displayed message IDs from existing messages on page load
        document.addEventListener('DOMContentLoaded', function() {
            const existingMessages = document.querySelectorAll('#messagesContainer .message');
            existingMessages.forEach(msg => {
                const msgId = msg.getAttribute('data-message-id');
                if (msgId) {
                    displayedMessageIds.add(parseInt(msgId));
                }
            });
            
            // Clean up old entries from recentlyAddedMessages (older than 10 seconds)
            setInterval(() => {
                const now = Date.now();
                for (const [content, timestamp] of recentlyAddedMessages.entries()) {
                    if (now - timestamp > 10000) {
                        recentlyAddedMessages.delete(content);
                    }
                }
            }, 5000);
        });

        // Function to poll for new messages from the server
        async function pollForNewMessages(chatId, maxAttempts = 3) {
            if (!chatId || maxAttempts <= 0) return;
            
            try {
                const response = await fetch(`/StudyChat/GetMessages?chatId=${chatId}`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    console.warn('Failed to fetch messages:', response.status);
                    return;
                }

                const data = await response.json();
                if (!data.messages || !Array.isArray(data.messages)) {
                    return;
                }

                // Get current user ID from the page (stored in a data attribute or variable)
                const chatIdInput = document.getElementById('currentChatId');
                const userId = chatIdInput ? chatIdInput.getAttribute('data-user-id') : null;

                // Add any new messages that aren't already displayed
                let hasNewMessages = false;
                data.messages.forEach(msg => {
                    // Skip if we've already displayed this message ID
                    if (displayedMessageIds.has(msg.id)) {
                        return;
                    }
                    
                    // Check if this message content was recently added (to avoid duplicates)
                    const messageKey = msg.content.trim().substring(0, 50); // Use first 50 chars as key
                    const recentlyAdded = recentlyAddedMessages.get(messageKey);
                    if (recentlyAdded && (Date.now() - recentlyAdded < 5000)) {
                        // This message was recently added, skip it to avoid duplicate
                        displayedMessageIds.add(msg.id); // Mark as displayed so we don't check again
                        return;
                    }
                    
                    // New message - add it
                    displayedMessageIds.add(msg.id);
                    
                    // Determine if message is from user or AI
                    // sender_id = 1 ‚Üí AI message
                    // sender_id = current user id ‚Üí User message
                    const isUser = msg.senderId && msg.senderId !== 1 && userId && 
                                  (msg.senderId.toString() === userId || msg.senderId === parseInt(userId));
                    
                    addMessageToChat(msg.content, isUser, msg.id);
                    hasNewMessages = true;
                });

                // If we got new messages and haven't exhausted attempts, poll again
                if (hasNewMessages && maxAttempts > 1) {
                    setTimeout(() => {
                        pollForNewMessages(chatId, maxAttempts - 1);
                    }, 2000); // Poll again after 2 seconds
                }
            } catch (error) {
                console.error('Error polling for messages:', error);
            }
        }

        // Quiz functionality
        let currentQuiz = null;
        let quizAnswers = {}; // Store user answers: { q1: 'A', q2: 'B', ... }
        let quizSubmitted = false;

        // Load quiz when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            const quizContainer = document.getElementById('quizContainer');
            if (quizContainer) {
                const chatId = quizContainer.getAttribute('data-chat-id');
                if (chatId) {
                    await loadQuiz(parseInt(chatId));
                }
            }
        });

        // Load quiz data from server
        async function loadQuiz(chatId) {
            try {
                const response = await fetch(`/StudyChat/GetQuiz?chatId=${chatId}`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.quiz && data.quiz.quiz_json) {
                        currentQuiz = data.quiz;
                        renderQuiz(data.quiz.quiz_json);
                    }
                }
            } catch (error) {
                console.error('Failed to load quiz:', error);
            }
        }

        // Render quiz UI
        function renderQuiz(quizJson) {
            const quizContainer = document.getElementById('quizContainer');
            if (!quizContainer) return;

            // Convert quiz_json object to array (q1, q2, q3, q4, q5)
            const questions = Object.entries(quizJson)
                .filter(([key]) => key.startsWith('q') && /^q\d+$/.test(key))
                .sort(([keyA], [keyB]) => {
                    const numA = parseInt(keyA.substring(1));
                    const numB = parseInt(keyB.substring(1));
                    return numA - numB;
                })
                .map(([key, value]) => ({ key, ...value }));

            if (questions.length === 0) {
                return; // No questions found
            }

            // Reset state
            quizAnswers = {};
            quizSubmitted = false;

            // Create quiz HTML
            let quizHTML = `
                <div class="quiz-wrapper">
                    <div class="quiz-header">
                        <h3 class="quiz-title">üìù Quiz Mode</h3>
                        <div class="quiz-progress">
                            <span id="quizProgress">0</span>/${questions.length} questions answered
                        </div>
                    </div>
                    <div class="quiz-questions" id="quizQuestions">
            `;

            // Render each question
            questions.forEach((q, index) => {
                const questionNum = index + 1;
                quizHTML += `
                    <div class="quiz-question" data-question-key="${q.key}">
                        <div class="question-header">
                            <span class="question-number">Question ${questionNum}</span>
                        </div>
                        <div class="question-text">${escapeHtml(q.question || '')}</div>
                        <div class="question-options">
                            <label class="option-label" data-option="A">
                                <input type="radio" name="${q.key}" value="A" class="option-radio">
                                <span class="option-text">A. ${escapeHtml(q.A || '')}</span>
                            </label>
                            <label class="option-label" data-option="B">
                                <input type="radio" name="${q.key}" value="B" class="option-radio">
                                <span class="option-text">B. ${escapeHtml(q.B || '')}</span>
                            </label>
                            <label class="option-label" data-option="C">
                                <input type="radio" name="${q.key}" value="C" class="option-radio">
                                <span class="option-text">C. ${escapeHtml(q.C || '')}</span>
                            </label>
                            <label class="option-label" data-option="D">
                                <input type="radio" name="${q.key}" value="D" class="option-radio">
                                <span class="option-text">D. ${escapeHtml(q.D || '')}</span>
                            </label>
                        </div>
                    </div>
                `;
            });

            quizHTML += `
                    </div>
                    <div class="quiz-actions">
                        <button type="button" class="quiz-submit-btn" id="quizSubmitBtn" onclick="submitQuiz()">
                            Submit Quiz
                        </button>
                    </div>
                    <div class="quiz-results" id="quizResults" style="display: none;"></div>
                </div>
            `;

            quizContainer.innerHTML = quizHTML;
            quizContainer.style.display = 'block';

            // Add event listeners for radio buttons
            const radioButtons = quizContainer.querySelectorAll('.option-radio');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    const questionKey = this.name;
                    quizAnswers[questionKey] = this.value;
                    updateQuizProgress();
                });
            });

            // Scroll to quiz
            quizContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Update quiz progress
        function updateQuizProgress() {
            const progressElement = document.getElementById('quizProgress');
            if (progressElement) {
                const answeredCount = Object.keys(quizAnswers).length;
                progressElement.textContent = answeredCount;
            }
        }

        // Submit quiz and grade
        function submitQuiz() {
            if (quizSubmitted) return;

            const quizContainer = document.getElementById('quizContainer');
            if (!quizContainer || !currentQuiz || !currentQuiz.quiz_json) return;

            const questions = Object.entries(currentQuiz.quiz_json)
                .filter(([key]) => key.startsWith('q') && /^q\d+$/.test(key))
                .sort(([keyA], [keyB]) => {
                    const numA = parseInt(keyA.substring(1));
                    const numB = parseInt(keyB.substring(1));
                    return numA - numB;
                })
                .map(([key, value]) => ({ key, ...value }));

            let correctCount = 0;
            const results = [];

            // Grade each question
            questions.forEach((q, index) => {
                const userAnswer = quizAnswers[q.key] || null;
                const correctAnswer = q.code || null;
                const isCorrect = userAnswer === correctAnswer;
                
                if (isCorrect) correctCount++;
                
                results.push({
                    key: q.key,
                    question: q.question,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    isCorrect: isCorrect,
                    options: {
                        A: q.A,
                        B: q.B,
                        C: q.C,
                        D: q.D
                    }
                });
            });

            // Display results
            displayQuizResults(results, correctCount, questions.length);

            quizSubmitted = true;
            
            // Disable submit button
            const submitBtn = document.getElementById('quizSubmitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Quiz Submitted';
            }
        }

        // Display quiz results
        function displayQuizResults(results, correctCount, totalQuestions) {
            const resultsContainer = document.getElementById('quizResults');
            if (!resultsContainer) return;

            const scorePercentage = Math.round((correctCount / totalQuestions) * 100);
            
            let resultsHTML = `
                <div class="quiz-results-header">
                    <h3>Quiz Results</h3>
                    <div class="quiz-score">
                        <span class="score-value">${correctCount}/${totalQuestions}</span>
                        <span class="score-percentage">(${scorePercentage}%)</span>
                    </div>
                </div>
                <div class="quiz-results-questions">
            `;

            results.forEach((result, index) => {
                const questionNum = index + 1;
                resultsHTML += `
                    <div class="result-question ${result.isCorrect ? 'correct' : 'incorrect'}">
                        <div class="result-question-header">
                            <span class="result-question-number">Question ${questionNum}</span>
                            <span class="result-status">${result.isCorrect ? '‚úì Correct' : '‚úó Incorrect'}</span>
                        </div>
                        <div class="result-question-text">${escapeHtml(result.question)}</div>
                        <div class="result-options">
                `;

                // Show all options with highlighting
                ['A', 'B', 'C', 'D'].forEach(option => {
                    const isUserAnswer = result.userAnswer === option;
                    const isCorrectAnswer = result.correctAnswer === option;
                    let optionClass = '';
                    
                    if (isCorrectAnswer) {
                        optionClass = 'correct-answer';
                    } else if (isUserAnswer && !result.isCorrect) {
                        optionClass = 'wrong-answer';
                    }

                    resultsHTML += `
                        <div class="result-option ${optionClass}">
                            <span class="result-option-label">${option}.</span>
                            <span class="result-option-text">${escapeHtml(result.options[option])}</span>
                            ${isCorrectAnswer ? '<span class="result-badge correct-badge">Correct Answer</span>' : ''}
                            ${isUserAnswer && !result.isCorrect ? '<span class="result-badge wrong-badge">Your Answer</span>' : ''}
                        </div>
                    `;
                });

                resultsHTML += `
                        </div>
                    </div>
                `;
            });

            resultsHTML += `
                </div>
            `;

            resultsContainer.innerHTML = resultsHTML;
            resultsContainer.style.display = 'block';

            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
}

